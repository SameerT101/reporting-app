<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Auth0 Spring Boot Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h1 class="h3 mb-0">üéâ Auth0 + Spring Boot Integration</h1>
                </div>
                <div class="card-body">

                    <!-- Show when NOT authenticated -->
                    <div sec:authorize="!isAuthenticated()">
                        <div class="text-center mb-4">
                            <h2>Auth0 + PDF Reports Testing</h2>
                            <p class="lead">This page demonstrates two ways to access Auth0 authenticated PDF
                                reports</p>
                        </div>

                        <!-- Web Interface Section -->
                        <div class="card mb-4">
                            <div class="card-body text-center">
                                <h5 class="card-title">üåê Option 1: Web Interface</h5>
                                <p class="card-text">Login through the browser to access reports via web interface</p>

                                <div class="alert alert-info mb-3">
                                    <strong>üîë Test Account Credentials:</strong><br>
                                    <div class="d-flex justify-content-center gap-3 mt-2">
                                        <div>
                                            <small class="text-muted">Username:</small><br>
                                            <code id="username">noname@acme.com</code>
                                            <button class="btn btn-sm btn-outline-secondary ms-1"
                                                    onclick="copyText('username')" title="Copy username">üìã
                                            </button>
                                        </div>
                                        <div>
                                            <small class="text-muted">Password:</small><br>
                                            <code id="password">Passw0rd$123</code>
                                            <button class="btn btn-sm btn-outline-secondary ms-1"
                                                    onclick="copyText('password')" title="Copy password">üìã
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <a class="btn btn-primary btn-lg" target="_blank"
                                   th:href="@{/oauth2/authorization/auth0}">
                                    üîê Login with Auth0 (New Tab)
                                </a>
                            </div>
                        </div>

                        <!-- API Interface Section -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">üîß Option 2: API Interface</h5>
                                <p class="card-text">Use direct API calls with JWT tokens (curl/Postman)</p>

                                <div class="alert alert-info mb-3">
                                    <strong>üîë For API testing, use the same credentials above</strong><br>
                                    <small class="text-muted">Username: <code>noname@acme.com</code> | Password: <code>Passw0rd$123</code></small>
                                </div>

                                <div class="mt-3">
                                    <h6><strong>Step 1: Get Access Token</strong></h6>
                                    <div class="position-relative">
                                        <pre class="bg-light p-3 rounded" id="curl1" style="font-size: 12px;">curl --location 'http://localhost:3000/api/auth/api-login-client' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'username=noname@acme.com' \
--data-urlencode 'password=Passw0rd$123'</pre>
                                        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2"
                                                onclick="copyCurl('curl1')" title="Copy to clipboard">
                                            üìã
                                        </button>
                                    </div>

                                    <h6 class="mt-4"><strong>Step 2: Download PDF</strong></h6>
                                    <div class="position-relative">
                                        <pre class="bg-light p-3 rounded" id="curl2" style="font-size: 12px;">curl -X GET http://localhost:3000/api/reports/pdf \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -o report.pdf</pre>
                                        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2"
                                                onclick="copyCurl('curl2')" title="Copy to clipboard">
                                            üìã
                                        </button>
                                    </div>

                                    <h6 class="mt-4"><strong>Step 3: Email PDF</strong></h6>
                                    <div class="position-relative">
                                        <pre class="bg-light p-3 rounded" id="curl3" style="font-size: 12px;">curl -X POST http://localhost:3000/api/reports/email \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"reportType":"product_of_all_categories","userEmail":"user@example.com"}'</pre>
                                        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2"
                                                onclick="copyCurl('curl3')" title="Copy to clipboard">
                                            üìã
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Show when authenticated -->
                    <div sec:authorize="isAuthenticated()">
                        <div class="alert alert-success">
                            <h4>‚úÖ Authentication Successful!</h4>
                            <p class="mb-0">You are now logged in with Auth0</p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h5>üë§ User Information</h5>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Name:</strong></td>
                                        <td th:text="${username}">User Name</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Email:</strong></td>
                                        <td th:text="${email}">user@example.com</td>
                                    </tr>
                                </table>
                            </div>

                            <div class="col-md-6">
                                <h5>üìÑ PDF Reports</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="testAPI('/api/reports/pdf')">
                                        üì• Download PDF Report
                                    </button>
                                    <button class="btn btn-primary" onclick="showEmailForm()">
                                        üìß Email PDF Report
                                    </button>
                                </div>

                                <!-- Email Form -->
                                <div class="mt-3" id="email-form" style="display: none;">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>üìß Email PDF Report</h6>
                                            <div class="mb-3">
                                                <label class="form-label" for="emailAddress">Email Address</label>
                                                <input class="form-control" id="emailAddress" placeholder="Enter email address"
                                                       th:value="${email}" type="email">
                                            </div>
                                            <div class="d-grid gap-2 d-md-flex">
                                                <button class="btn btn-success btn-sm" onclick="sendEmailReport()">Send
                                                    Email
                                                </button>
                                                <button class="btn btn-secondary btn-sm"
                                                        onclick="hideEmailForm(); clearResults()">Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3" id="api-results"></div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <form class="d-inline" method="post" th:action="@{/logout}">
                                <button class="btn btn-danger" type="submit">
                                    üö™ Logout
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function testAPI(endpoint) {
        const resultsDiv = document.getElementById('api-results');
        resultsDiv.innerHTML = '<div class="text-info">Testing ' + endpoint + '...</div>';

        try {
            const response = await fetch(endpoint);

            if (response.ok) {
                // Check if this is a PDF download
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/pdf')) {
                    // Handle PDF download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'products-report.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ ${endpoint}</strong><br>
                            PDF report downloaded successfully!
                        </div>
                    `;
                } else {
                    // Handle text responses
                    const data = await response.text();
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ ${endpoint}</strong><br>
                            <pre style="font-size: 12px; margin: 0;">${data}</pre>
                        </div>
                    `;
                }
            } else {
                const data = await response.text();
                resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå ${endpoint}</strong><br>
                            Error ${response.status}: ${data}
                        </div>
                    `;
            }
        } catch (error) {
            resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå ${endpoint}</strong><br>
                        Network error: ${error.message}
                    </div>
                `;
        }
    }

    function showEmailForm() {
        document.getElementById('email-form').style.display = 'block';
    }

    function hideEmailForm() {
        document.getElementById('email-form').style.display = 'none';
    }

    function clearResults() {
        document.getElementById('api-results').innerHTML = '';
    }

    async function sendEmailReport() {
        const emailAddress = document.getElementById('emailAddress').value;
        const resultsDiv = document.getElementById('api-results');

        if (!emailAddress) {
            resultsDiv.innerHTML = `
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Please enter an email address</strong>
                </div>
            `;
            return;
        }

        resultsDiv.innerHTML = '<div class="text-info">Sending email report...</div>';

        try {
            const response = await fetch('/api/reports/email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reportType: 'product_of_all_categories',
                    userEmail: emailAddress
                })
            });

            if (response.ok) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Email report sent successfully!</strong><br>
                        PDF report has been queued for delivery to: ${emailAddress}<br><br>
                        <div class="mt-2">
                            <strong>üì¨ Check your email:</strong><br>
                            <small class="text-muted">Using local mail server (MailHog) at:</small><br>
                            <code>http://localhost:8025</code><br>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="openMailDashboard()">
                                üìß Open Mail Dashboard
                            </button>
                        </div>
                    </div>
                `;
                hideEmailForm(); // Hide the form but keep the success message visible
            } else {
                const errorText = await response.text();
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Failed to send email report</strong><br>
                        Error ${response.status}: ${errorText}
                    </div>
                `;
            }
        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>‚ùå Error sending email report</strong><br>
                    Network error: ${error.message}
                </div>
            `;
        }
    }

    function copyCurl(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;

        navigator.clipboard.writeText(text).then(() => {
            // Show temporary feedback
            const button = element.nextElementSibling;
            const originalText = button.innerHTML;
            button.innerHTML = '‚úÖ';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');

            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 1500);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('‚ùå Failed to copy to clipboard');
        });
    }

    function openMailDashboard() {
        // Force focus on opening window
        const newWindow = window.open('http://localhost:8025', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        if (newWindow) {
            newWindow.focus();
        } else {
            // Fallback if popup is blocked
            alert('Popup blocked! Please open http://localhost:8025 manually to check your emails.');
        }
    }

    function copyText(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;

        navigator.clipboard.writeText(text).then(() => {
            // Show temporary feedback
            const button = element.nextElementSibling;
            const originalText = button.innerHTML;
            button.innerHTML = '‚úÖ';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');

            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 1500);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('‚ùå Failed to copy to clipboard');
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>